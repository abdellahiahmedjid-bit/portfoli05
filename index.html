<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ø­Ø¸Ø±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ù†Ø§ÙØ¹ - ÙØ±Ø¹ Ù„ÙƒØµØ±</title>
    <style>
        :root {
            --primary-color: #1b4d3e;
            --gold: #c5a021;
            --bg: #f9f9f9;
            --success: #5cb85c;
            --danger: #d9534f;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            color: #333;
            min-height: 100vh;
        }

        .main-container {
            max-width: 900px;
            margin: auto;
        }

        .header {
            text-align: center;
            background: linear-gradient(135deg, var(--primary-color) 0%, #266b57 100%);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header h1 {
            margin: 0;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-top: 6px solid var(--gold);
            margin-bottom: 30px;
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }

        h2 {
            color: var(--primary-color);
            margin-top: 0;
            border-bottom: 3px solid var(--gold);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--primary-color);
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        button {
            width: 100%;
            background: linear-gradient(135deg, var(--primary-color) 0%, #266b57 100%);
            color: white;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(27, 77, 62, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .table-container {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }

        th {
            background: linear-gradient(135deg, var(--primary-color) 0%, #266b57 100%);
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .status-rejected {
            color: var(--danger);
            font-weight: bold;
            background-color: #ffe6e6;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .status-accepted {
            color: var(--success);
            font-weight: bold;
            background-color: #e6ffe6;
            padding: 5px 10px;
            border-radius: 5px;
        }

        .delete-btn {
            background: var(--danger);
            padding: 8px 15px;
            font-size: 13px;
            width: auto;
            border-radius: 5px;
        }

        .delete-btn:hover {
            background: #c9302c;
        }

        .info-text {
            text-align: center;
            font-size: 13px;
            color: #666;
            margin-top: 15px;
            padding: 10px;
            background-color: #f0f8ff;
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.5em;
            }
            
            .stat-number {
                font-size: 2em;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 10px 5px;
            }
        }
    </style>
</head>
<body>

<div class="main-container">
    <div class="header">
        <h1>ğŸ•Œ Ù…Ø­Ø¸Ø±Ø© Ø§Ù„Ø¥Ù…Ø§Ù… Ù†Ø§ÙØ¹ - ÙØ±Ø¹ Ù„ÙƒØµØ±</h1>
        <p>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³Ø§Ø¨Ù‚Ø© Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</p>
    </div>

    <div class="stats-container">
        <div class="stat-box">
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ±Ø´Ø­ÙŠÙ†</div>
            <div class="stat-number" id="totalCount">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙŠÙ†</div>
            <div class="stat-number" style="color: var(--success);" id="acceptedCount">0</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Ø§Ù„Ù…Ø±ÙÙˆØ¶ÙŠÙ†</div>
            <div class="stat-number" style="color: var(--danger);" id="rejectedCount">0</div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù…ØªØ±Ø´Ø­ Ø¬Ø¯ÙŠØ¯</h2>
        
        <div class="form-group">
            <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„: <span style="color: red;">*</span></label>
            <input type="text" id="studentName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ±Ø´Ø­ Ø§Ù„ÙƒØ§Ù…Ù„" autocomplete="off">
        </div>

        <div class="form-group">
            <label>Ø§Ù„Ù…Ø­Ø¸Ø±Ø©: <span style="color: red;">*</span></label>
            <input type="text" id="mahdara" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø¸Ø±Ø©" autocomplete="off" list="mahdara-list">
            <datalist id="mahdara-list"></datalist>
        </div>

        <div class="form-group">
            <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: <span style="color: red;">*</span></label>
            <input type="tel" id="phoneNumber" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ù…Ø«Ø§Ù„: 22123456)" pattern="[0-9]{8,}" autocomplete="off">
            <small style="color: #666; font-size: 12px;">ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 8 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</small>
        </div>

        <div class="form-group">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: <span style="color: red;">*</span></label>
            <input type="date" id="birthDate" max="">
            <small id="ageDisplay" style="color: #666; font-size: 12px; display: block; margin-top: 5px;"></small>
        </div>

        <div class="form-group">
            <label>ÙØ±Ø¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©: <span style="color: red;">*</span></label>
            <select id="quranBranch">
                <option value="Ø§Ù„Ù‚Ø±Ø¢Ù† ÙƒØ§Ù…Ù„Ø§Ù‹">Ø§Ù„Ù‚Ø±Ø¢Ù† ÙƒØ§Ù…Ù„Ø§Ù‹</option>
                <option value="Ù†ØµÙ Ø§Ù„Ù‚Ø±Ø¢Ù†">Ù†ØµÙ Ø§Ù„Ù‚Ø±Ø¢Ù†</option>
                <option value="Ø®Ù…Ø³ Ø§Ù„Ù‚Ø±Ø¢Ù†">Ø®Ù…Ø³ Ø§Ù„Ù‚Ø±Ø¢Ù†</option>
                <option value="Ø¹Ø´Ø± Ø§Ù„Ù‚Ø±Ø¢Ù†">Ø¹Ø´Ø± Ø§Ù„Ù‚Ø±Ø¢Ù†</option>
            </select>
        </div>

        <button onclick="registerStudent()">âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ±Ø´Ø­</button>
        <div id="saveStatus" style="text-align: center; margin-top: 10px; font-size: 14px;"></div>
    </div>

    <div class="table-container">
        <h2>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ±Ø´Ø­ÙŠÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h2>
        
        <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
            <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù…Ø­Ø¸Ø±Ø© Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." 
                   style="flex: 1; min-width: 250px;" onkeyup="filterStudents()">
            
            <select id="filterDecision" onchange="filterStudents()" style="width: auto; min-width: 150px;">
                <option value="">Ø§Ù„ÙƒÙ„</option>
                <option value="Ù…Ù‚Ø¨ÙˆÙ„">Ø§Ù„Ù…Ù‚Ø¨ÙˆÙ„ÙŠÙ† ÙÙ‚Ø·</option>
                <option value="Ù…Ø±ÙÙˆØ¶">Ø§Ù„Ù…Ø±ÙÙˆØ¶ÙŠÙ† ÙÙ‚Ø·</option>
            </select>
            
            <button onclick="exportToCSV()" style="width: auto; padding: 10px 20px; font-size: 14px;">
                ğŸ“¥ ØªØµØ¯ÙŠØ± Excel
            </button>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
                    <th>Ø§Ù„Ù…Ø­Ø¸Ø±Ø©</th>
                    <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                    <th>Ø§Ù„Ø¹Ù…Ø±</th>
                    <th>ÙØ±Ø¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</th>
                    <th>Ø§Ù„Ù‚Ø±Ø§Ø±</th>
                    <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="studentsList">
                <tr>
                    <td colspan="9" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                </tr>
            </tbody>
        </table>
        <div class="info-text">
            â„¹ï¸ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±ÙƒØ²ÙŠØ© Ù…Ø´ØªØ±ÙƒØ© ÙˆÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡Ø§ Ù…Ù† Ø£ÙŠ Ù…ØªØµÙØ­ Ø£Ùˆ Ø¬Ù‡Ø§Ø²
        </div>
    </div>
</div>

<script>
    let allStudents = []; // ØªØ®Ø²ÙŠÙ† ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    document.addEventListener('DOMContentLoaded', () => {
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (Ø§Ù„ÙŠÙˆÙ…)
        document.getElementById('birthDate').setAttribute('max', new Date().toISOString().split('T')[0]);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
        document.getElementById('birthDate').addEventListener('change', function() {
            const ageDisplay = document.getElementById('ageDisplay');
            if (this.value) {
                const age = calculateAge(this.value);
                const status = age < 23 ? "âœ… Ù…Ù‚Ø¨ÙˆÙ„" : "âŒ Ù…Ø±ÙÙˆØ¶";
                const color = age < 23 ? "#5cb85c" : "#d9534f";
                ageDisplay.innerHTML = `Ø§Ù„Ø¹Ù…Ø±: <strong style="color: ${color};">${age} Ø³Ù†Ø©</strong> - Ø§Ù„Ø­Ø§Ù„Ø©: <strong style="color: ${color};">${status}</strong>`;
            } else {
                ageDisplay.innerHTML = '';
            }
        });
        
        displayStudents();
        loadMahdharaList();
    });

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø±
    function calculateAge(dobInput) {
        const birthDate = new Date(dobInput);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    }

    // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹
    async function loadMahdharaList() {
        try {
            const studentsResult = await window.storage.get('mahdara_students', true);
            if (studentsResult && studentsResult.value) {
                const students = JSON.parse(studentsResult.value);
                const mahdharas = [...new Set(students.map(s => s.mahdara).filter(m => m))];
                
                const datalist = document.getElementById('mahdara-list');
                datalist.innerHTML = mahdharas.map(m => `<option value="${m}">`).join('');
            }
        } catch (error) {
            console.log('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¸Ø± Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ø¹Ø¯');
        }
    }

    // Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ù…ØªØ±Ø´Ø­ Ø¬Ø¯ÙŠØ¯
    async function registerStudent() {
        const saveStatus = document.getElementById('saveStatus');
        saveStatus.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';
        saveStatus.style.color = '#666';
        
        const name = document.getElementById('studentName').value.trim();
        const mahdara = document.getElementById('mahdara').value.trim();
        const phoneNumber = document.getElementById('phoneNumber').value.trim();
        const dobInput = document.getElementById('birthDate').value;
        const branch = document.getElementById('quranBranch').value;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        if (!name) {
            alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„");
            saveStatus.innerHTML = '';
            return;
        }

        if (!mahdara) {
            alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø¸Ø±Ø©");
            saveStatus.innerHTML = '';
            return;
        }

        if (!phoneNumber) {
            alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
            saveStatus.innerHTML = '';
            return;
        }

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (8 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)
        if (phoneNumber.length < 8 || !/^\d+$/.test(phoneNumber)) {
            alert("âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 8 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØ£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·");
            saveStatus.innerHTML = '';
            return;
        }

        if (!dobInput) {
            alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯");
            saveStatus.innerHTML = '';
            return;
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø±
        const age = calculateAge(dobInput);

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¹Ù…Ø±
        if (age < 0 || age > 100) {
            alert("âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­");
            saveStatus.innerHTML = '';
            return;
        }

        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø±Ø§Ø± (Ù…Ù‚Ø¨ÙˆÙ„ Ø£Ùˆ Ù…Ø±ÙÙˆØ¶)
        const decision = (age < 23) ? "Ù…Ù‚Ø¨ÙˆÙ„" : "Ù…Ø±ÙÙˆØ¶";

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ±Ø´Ø­
        const studentData = {
            id: Date.now(),
            name: name,
            mahdara: mahdara,
            phoneNumber: phoneNumber,
            age: age,
            branch: branch,
            decision: decision,
            registrationDate: new Date().toISOString()
        };

        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
            let studentsResult = await window.storage.get('mahdara_students', true);
            let students = [];
            
            if (studentsResult && studentsResult.value) {
                students = JSON.parse(studentsResult.value);
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ±Ø´Ø­ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            students.push(studentData);
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
            await window.storage.set('mahdara_students', JSON.stringify(students), true);
            
            saveStatus.innerHTML = 'âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!';
            saveStatus.style.color = '#5cb85c';
            
            setTimeout(() => {
                saveStatus.innerHTML = '';
            }, 3000);
            
            // Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­
            alert(`âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ±Ø´Ø­ Ø¨Ù†Ø¬Ø§Ø­!\n\nØ§Ù„Ø§Ø³Ù…: ${name}\nØ§Ù„Ù…Ø­Ø¸Ø±Ø©: ${mahdara}\nØ§Ù„Ù‡Ø§ØªÙ: ${phoneNumber}\nØ§Ù„Ø¹Ù…Ø±: ${age} Ø³Ù†Ø©\nØ§Ù„Ù‚Ø±Ø§Ø±: ${decision}`);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            await displayStudents();
            await loadMahdharaList();
            
            // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('studentName').value = '';
            document.getElementById('mahdara').value = '';
            document.getElementById('phoneNumber').value = '';
            document.getElementById('birthDate').value = '';
            document.getElementById('quranBranch').selectedIndex = 0;
            document.getElementById('ageDisplay').innerHTML = '';
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', error);
            saveStatus.innerHTML = 'âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸';
            saveStatus.style.color = '#d9534f';
            alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        }
    }

    // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ±Ø´Ø­ÙŠÙ†
    async function displayStudents() {
        const list = document.getElementById('studentsList');
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
            const studentsResult = await window.storage.get('mahdara_students', true);
            let students = [];
            
            if (studentsResult && studentsResult.value) {
                students = JSON.parse(studentsResult.value);
            }
            
            allStudents = students; // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¨Ø­Ø«
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            updateStats(students);
            
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
            if (students.length === 0) {
                list.innerHTML = '<tr><td colspan="9" style="text-align:center; color: #999; padding: 30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø¨Ø¹Ø¯</td></tr>';
                return;
            }
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªØ±Ø´Ø­ÙŠÙ† (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            students.sort((a, b) => b.id - a.id);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ±Ø´Ø­ÙŠÙ†
            renderStudentsList(students);
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            list.innerHTML = '<tr><td colspan="9" style="text-align:center; color: #999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</td></tr>';
        }
    }

    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ±Ø´Ø­ÙŠÙ† ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    function renderStudentsList(students) {
        const list = document.getElementById('studentsList');
        
        if (students.length === 0) {
            list.innerHTML = '<tr><td colspan="9" style="text-align:center; color: #999; padding: 30px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
            return;
        }
        
        list.innerHTML = '';
        students.forEach((student, index) => {
            const statusClass = (student.decision === "Ù…Ø±ÙÙˆØ¶") ? "status-rejected" : "status-accepted";
            const rowNumber = index + 1;
            const regDate = new Date(student.registrationDate).toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            
            list.innerHTML += `
                <tr>
                    <td><strong>${rowNumber}</strong></td>
                    <td>${student.name}</td>
                    <td>${student.mahdara || '-'}</td>
                    <td>${student.phoneNumber || '-'}</td>
                    <td>${student.age} Ø³Ù†Ø©</td>
                    <td>${student.branch}</td>
                    <td><span class="${statusClass}">${student.decision}</span></td>
                    <td style="font-size: 12px;">${regDate}</td>
                    <td>
                        <button class="delete-btn" onclick="deleteStudent(${student.id})">
                            ğŸ—‘ï¸ Ø­Ø°Ù
                        </button>
                    </td>
                </tr>
            `;
        });
    }

    // ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ØªØ±Ø´Ø­ÙŠÙ†
    function filterStudents() {
        const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();
        const decisionFilter = document.getElementById('filterDecision').value;
        
        let filtered = allStudents;
        
        // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±Ø§Ø±
        if (decisionFilter) {
            filtered = filtered.filter(s => s.decision === decisionFilter);
        }
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø­Ø¸Ø±Ø© ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
        if (searchTerm) {
            filtered = filtered.filter(s => 
                s.name.toLowerCase().includes(searchTerm) ||
                (s.mahdara && s.mahdara.toLowerCase().includes(searchTerm)) ||
                (s.phoneNumber && s.phoneNumber.includes(searchTerm))
            );
        }
        
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        filtered.sort((a, b) => b.id - a.id);
        
        renderStudentsList(filtered);
    }

    // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    function updateStats(students) {
        const total = students.length;
        const accepted = students.filter(s => s.decision === "Ù…Ù‚Ø¨ÙˆÙ„").length;
        const rejected = students.filter(s => s.decision === "Ù…Ø±ÙÙˆØ¶").length;
        
        document.getElementById('totalCount').textContent = total;
        document.getElementById('acceptedCount').textContent = accepted;
        document.getElementById('rejectedCount').textContent = rejected;
    }

    // Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ù…ØªØ±Ø´Ø­
    async function deleteStudent(id) {
        // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù
        if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØ±Ø´Ø­ØŸ\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡.")) {
            return;
        }
        
        try {
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            let studentsResult = await window.storage.get('mahdara_students', true);
            let students = [];
            
            if (studentsResult && studentsResult.value) {
                students = JSON.parse(studentsResult.value);
            }
            
            // Ø­Ø°Ù Ø§Ù„Ù…ØªØ±Ø´Ø­
            students = students.filter(s => s.id !== id);
            
            // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø¯Ø«Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ Ø§Ù„Ù…Ø´ØªØ±Ùƒ
            await window.storage.set('mahdara_students', JSON.stringify(students), true);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            await displayStudents();
            
            alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØªØ±Ø´Ø­ Ø¨Ù†Ø¬Ø§Ø­");
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:', error);
            alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        }
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ CSV (Excel)
    function exportToCSV() {
        if (allStudents.length === 0) {
            alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
            return;
        }
        
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        let csv = '\uFEFF'; // BOM for UTF-8
        csv += 'Ø§Ù„Ø±Ù‚Ù…,Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„,Ø§Ù„Ù…Ø­Ø¸Ø±Ø©,Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ,Ø§Ù„Ø¹Ù…Ø±,ÙØ±Ø¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©,Ø§Ù„Ù‚Ø±Ø§Ø±,ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„\n';
        
        allStudents.forEach((student, index) => {
            const regDate = new Date(student.registrationDate).toLocaleDateString('ar-EG');
            csv += `${index + 1},"${student.name}","${student.mahdara}","${student.phoneNumber}",${student.age},"${student.branch}","${student.decision}","${regDate}"\n`;
        });
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `Ù…ØªØ±Ø´Ø­ÙŠÙ†_Ù…Ø­Ø¸Ø±Ø©_Ø§Ù„Ø¥Ù…Ø§Ù…_Ù†Ø§ÙØ¹_${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        alert("âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!");
    }
</script>

</body>
</html>